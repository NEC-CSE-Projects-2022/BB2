<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fire Detection Alarm Panel</title>
<script src="https://kit.fontawesome.com/ff0f0e9783.js" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root{
  --accent:#00eaff; --text:#e9faff; --bg:#000; --panel:#0b0e11;
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family:'Roboto',sans-serif; height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.title-bar{
  position:absolute; top:8px; width:100%; text-align:center;
  font-family:'Orbitron',sans-serif; font-size:24px; font-weight:600; color:var(--accent); letter-spacing:2px;
  text-shadow:0 0 12px var(--accent); pointer-events:none;
}
.frame{
  position:relative; width:92vw; height:82vh; background:var(--panel);
  border-radius:18px; box-shadow:0 0 50px rgba(0,255,255,.25); overflow:hidden; display:flex; align-items:center; justify-content:center;
}
#camera{
  width:100%; height:100%; object-fit:cover; /* NO CSS MIRROR NOW */
  background:#000;
}

/* Neon corners */
.corner{ position:absolute; width:55px; height:55px; border:3px solid var(--accent); filter:drop-shadow(0 0 12px var(--accent)); }
.tl{ top:40px; left:40px; border-right:none; border-bottom:none;}
.tr{ top:40px; right:40px; border-left:none; border-bottom:none;}
.bl{ bottom:40px; left:40px; border-right:none; border-top:none;}
.br{ bottom:40px; right:40px; border-left:none; border-top:none;}

/* Top info row */
.top-ui{
  position:absolute; top:55px; left:60px; right:60px;
  display:flex; justify-content:space-between; align-items:center; font-family:'Orbitron',sans-serif;
  pointer-events:none;
}
.battery{ display:flex; align-items:center; gap:20px; font-size:18px;}
#batterySVG{ width:34px; height:34px;}
#batText{ padding-left:6px; } /* nudge % a bit right */
.timegrp{ text-align:right;}
#date{ font-size:18px;} #time{ font-size:22px; font-weight:600;}

/* Badge is inline (left of battery %) */
#badge{
  padding:6px 10px; border-radius:8px; font-weight:700;
  display:inline-block;
  transition:transform .2s ease, opacity .2s ease, background .2s ease;
}
#badge.ok{ background:#12c35a; color:#fff; }
#badge.warn{ background:#ff9f0a; color:#fff; }
#badge.err{ background:#ff3b30; color:#fff; animation:pulse .6s infinite alternate; }
@keyframes pulse{
  from{ transform:scale(1); opacity:1; }
  to{ transform:scale(1.08); opacity:.75; }
}

/* Center timer */
#timer{
  position:absolute; bottom:85px; width:100%; text-align:center;
  font-family:'Orbitron',sans-serif; font-size:22px; letter-spacing:2px; text-shadow:0 0 10px #fff;
}

/* Bottom status row (icons, no emoji) */
.status{
  position:absolute; bottom:30px; width:100%;
  display:flex; justify-content:center; gap:70px; font-size:18px; align-items:center;
}
.status .item{ display:flex; align-items:center; gap:10px; }
.status .item img{ width:20px; height:20px; filter:drop-shadow(0 0 4px rgba(255,255,255,.15)); }

/* Rotate message */
.rotate{
  position:fixed; inset:0; background:#000; display:none; align-items:center; justify-content:center; color:#fff; font-size:24px;
}
@media(orientation:portrait){ .frame{display:none} .rotate{display:flex}}
</style>
</head>
<body>

<div class="rotate">ðŸ“± Rotate to Landscape Mode</div>
<div class="title-bar">FIRE DETECTION ALARM PANEL</div>

<div class="frame">
  <!-- Stream from backend (already mirrored & boxed in backend) -->
  <img id="camera" src="http://localhost:5000/video" alt="stream"/>

  <div class="corner tl"></div><div class="corner tr"></div>
  <div class="corner bl"></div><div class="corner br"></div>

  <div class="top-ui">
    <div class="battery">
      <!-- âœ… Badge moved here, left of battery percentage -->
      <span id="badge" class="ok">ONLINE</span>

      <span id="batText">--%</span>
      <svg id="batterySVG" viewBox="0 0 24 24" fill="none">
        <rect x="2" y="7" width="18" height="10" rx="2" stroke="white" stroke-width="2"/>
        <rect id="batFill" x="3" y="8" width="16" height="8" rx="1" fill="#00ff80"/>
        <rect x="20" y="10" width="2" height="4" rx="1" fill="white"/>
      </svg>
    </div>
    <div class="timegrp">
      <div id="date">-- -- ----</div>
      <div id="time">--:--:--</div>
    </div>
  </div>

  <div id="timer">00:00:00</div>

  <div class="status">
    <div class="item">
      <span> <i class="fa-solid fa-fire"></i>  Fire: <b id="fireStatus">No</b></span>
    </div>
    <div class="item">
      <span> <i class="fa-solid fa-stopwatch"></i>  Seen: <b id="seenVal">0.0s</b></span>
    </div>
    <div class="item">
      <span> <i class="fa-solid fa-bell"></i>  Alerts: <b id="alertCnt">0</b></span>
    </div>
  </div>
</div>

<script>
// ===== Battery =====
if (navigator.getBattery) {
  navigator.getBattery().then(b => {
    const upd = () => {
      const p = Math.round(b.level * 100);
      batText.textContent = p + "%";
      batFill.setAttribute("width", (p/100*16));
      batFill.setAttribute("fill", p < 20 ? "#ff4646" : p < 50 ? "#ffd34d" : "#00ff80");
    };
    upd(); b.addEventListener("levelchange", upd);
  });
}

// ===== Clock =====
function tick(){
  let d = new Date().toLocaleString("en-IN",{timeZone:"Asia/Kolkata"});
  d = new Date(d);
  time.textContent = d.toLocaleTimeString();
  date.textContent = d.toLocaleDateString();
}
setInterval(tick, 1000); tick();

// ===== Uptime Timer (pauses when backend offline) =====
let sec=0, timerActive=true;
setInterval(()=>{
  if(!timerActive) return;
  sec++;
  timer.textContent =
    String(sec/3600|0).padStart(2,'0')+":"+
    String((sec/60|0)%60).padStart(2,'0')+":"+
    String(sec%60).padStart(2,'0');
},1000);

// ===== Status Polling + Offline Recovery =====
let offlineCount = 0;
setInterval(()=>{
  fetch("http://localhost:5000/status",{cache:"no-store"})
    .then(r=>r.json())
    .then(d=>{
      offlineCount = 0;

      // badge state + animation class
      if (d.online){
        timerActive = true;
        if (d.fire){
          badge.textContent = "FIRE";
          badge.className = "err";
        } else {
          badge.textContent = "ONLINE";
          badge.className = "ok";
        }
      } else {
        // backend online flag false (but reachable)
        timerActive = false;
        timer.textContent = "Backend has an error";
        badge.textContent = "OFFLINE";
        badge.className = "warn";
      }

      // bottom stats
      fireStatus.textContent = d.fire ? "Yes" : "No";
      seenVal.textContent = (d.seen_seconds ?? 0).toFixed(1) + "s";
      alertCnt.textContent = d.alerts ?? 0;
    })
    .catch(()=>{
      // backend unreachable
      offlineCount++;
      timerActive = false;
      timer.textContent = "Backend has an error";
      badge.textContent = "OFFLINE";
      badge.className = "warn";

      // Try to re-connect the MJPEG stream while offline (faster retries)
      if (offlineCount % 3 === 0) {
        const src = camera.src; camera.src = ""; camera.src = src;
      }
    });
}, 600);
</script>
</body>
</html>
